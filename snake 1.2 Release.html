<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SNAKE 1.2 RELEASE | –°–ª–æ–∂–Ω–æ—Å—Ç—å, –ö–µ–π—Å—ã –∏ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</title>
    
    <style>
        /* CSS –°—Ç–∏–ª–∏ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            /* –§–û–ù: –§–∏–æ–ª–µ—Ç–æ–≤–æ-—Å–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            color: #ecf0f1;
            margin: 0;
            padding: 0;
            min-height: 100vh; 
            transition: background 0.3s; 
        }
        
        /* --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ----------------------------------- */
        #main-menu-content, #difficulty-menu-content {
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            z-index: 999; 
        }
        #main-menu-content.active, #difficulty-menu-content.active {
            display: flex;
        }

        #menu-title {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 50px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        }

        /* –°–ï–¢–ö–ê –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ */
        .menu-grid {
            display: grid;
            grid-template-areas: 
                ". play ."
                "achievements shop stats"
                ". inventory ."
                ". cases .";
            grid-template-columns: 200px 200px 200px;
            grid-template-rows: repeat(4, 80px); 
            gap: 15px;
            justify-items: center;
            align-items: center;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ */
        .menu-button {
            width: 150px;
            height: 50px;
            border: 2px solid black;
            border-radius: 5px;
            background-color: #3498db; 
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.5);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .menu-button:hover {
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.5);
            transform: translate(2px, 2px);
        }

        /* –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∑–æ–Ω–∞–º —Å–µ—Ç–∫–∏ */
        #btn-play { grid-area: play; width: 200px; } 
        #btn-achievements { grid-area: achievements; }
        #btn-shop { grid-area: shop; }
        #btn-stats { grid-area: stats; }
        #btn-inventory { grid-area: inventory; }
        #btn-cases { grid-area: cases; }


        /* --- UI –í–ï–†–•–ù–ò–ô –ü–ê–ù–ï–õ–¨ –î–õ–Ø –í–ö–õ–ê–î–û–ö --- */
        #header-bar {
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 20px;
            background-color: #34495e;
            display: none; 
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #progression-display { 
            display: none; 
            align-items: center; 
            font-size: 1.2em; 
        }
        
        .currency-item { display: flex; align-items: center; margin-left: 15px; padding: 5px 10px; background-color: #2c3e50; border-radius: 5px; border: 1px solid #7f8c8d; }
        .currency-item span { margin-left: 5px; font-weight: bold; }
        .coin-icon { color: gold; margin-right: 5px; }
        .score-icon { color: #f39c12; margin-right: 5px; }

        .back-button { 
            background-color: #c0392b; 
            color: white; 
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* --- –û–ë–©–ò–ô –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–û–ö --------------------------------------- */
        .tab-content { 
            display: none; 
            padding-top: 80px; 
            padding-bottom: 50px; 
            width: 90%; 
            max-width: 1000px; 
            margin-left: auto; 
            margin-right: auto; 
            background-color: transparent; 
            min-height: auto; 
            position: relative; 
        }
        .tab-content.active { 
            display: block; 
            z-index: 500;
        }
        .tab-content h2 { margin-top: 0; padding-top: 20px; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game-content { min-height: 100vh; } 
        #gameCanvas { border: 5px solid #2980b9; display: block; margin: 20px auto; background-color: #111; }
        
        /* --- –ò–ù–í–ï–ù–¢–ê–†–¨ / –ê–î–ú–ò–ù --- */
        #inventory-content { padding-top: 100px; }
        #inventory-content h3 { margin-top: 30px; }
        #admin-controls { margin-top: 50px; padding: 20px; border: 2px solid #9b59b6; border-radius: 10px; display: inline-flex; gap: 10px; align-items: center;}
        #admin-controls button { background-color: #8E44AD; font-size: 1.1em; padding: 10px 20px;}
        #admin-controls h3 { margin: 0; padding-right: 10px; border-right: 1px solid #9b59b6; }


        /* --- –ú–ê–ì–ê–ó–ò–ù –∏ –ò–ù–í–ï–ù–¢–ê–†–¨ --- */
        #skins-list, #inventory-skins-list { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; 
            margin-top: 20px;
        }
        .skin-item { 
            width: 160px; padding: 15px 10px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); transition: transform 0.2s; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
        .rarity-common { color: #9E9E9E; } .rarity-rare { color: #f39c12; } .rarity-epic { color: #9b59b6; } 
        .rarity-legendary { color: #FFD700; } .rarity-mythical { color: #c0392b; }
        
        /* --- –ö–ï–ô–°–´ –ê–ù–ò–ú–ê–¶–ò–Ø --- */
        #case-result-wrapper {
            position: relative;
            width: 700px;
            height: 120px;
            margin: 30px auto;
            border: 3px solid #7f8c8d;
            overflow: hidden; 
        }
        
        #skin-roll {
            display: flex;
            position: absolute;
            left: 0;
            top: 0;
            transition: transform 5s cubic-bezier(0.2, 0.9, 0.3, 1); 
        }
        
        .roll-item {
            min-width: 100px; 
            height: 120px;
            line-height: 120px;
            border-right: 1px solid rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            font-size: 0.8em;
            text-align: center;
            padding: 5px;
            cursor: default;
        }

        #indicator {
            position: absolute;
            left: 50%;
            top: 0;
            width: 4px;
            height: 100%;
            background-color: white;
            z-index: 10;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.9);
        }
        
        #case-status { margin-top: 10px; font-size: 1.1em; }

        /* --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-item {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 8px;
        }
        .stat-item h4 { margin: 0; font-size: 1.5em; }
        .stat-item p { margin: 5px 0 0; font-size: 0.9em; color: #bdc3c7; }

        .achievement-grid {
             display: flex;
             flex-wrap: wrap;
             justify-content: center;
             gap: 20px;
             margin-top: 30px;
        }
        .achievement-item {
            width: 200px;
            padding: 15px;
            border-radius: 8px;
            background-color: #2c3e50;
            border: 2px solid transparent;
        }
        .achievement-item.unlocked {
             border-color: #f1c40f;
             box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }
        .achievement-item h4 { margin-top: 0; }
        .achievement-status { font-size: 1.5em; margin-top: 5px; }
    </style>
</head>
<body>
    
    <div id="header-bar">
        <button class="back-button" onclick="showTab('main-menu')">‚Üê –ú–µ–Ω—é</button>
        
        <div id="progression-display">
            <div class="currency-item">
                <span class="score-icon">‚òÖ</span>
                <span id="score">0</span>
            </div>
            <div class="currency-item">
                <span class="coin-icon">üí∞</span>
                <span id="coins">0</span>
            </div>
            <button onclick="convertScoreToCoins()" style="background-color: #2ecc71; margin-left: 10px;">–û–±–º–µ–Ω (3:1)</button>
        </div>
        
        <button onclick="saveProgress()" style="background-color: #f39c12;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    
    <div id="main-menu-content" class="tab-content active">
        <div id="menu-title">SNAKE 1.2 RELEASE</div>
        <div class="menu-grid">
            <div id="btn-play" class="menu-button" onclick="showTab('difficulty-menu')">–ò–≥—Ä–∞—Ç—å</div> 
            
            <div id="btn-achievements" class="menu-button" onclick="showTab('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div id="btn-shop" class="menu-button" onclick="showTab('shop')">–ú–∞–≥–∞–∑–∏–Ω</div>
            <div id="btn-stats" class="menu-button" onclick="showTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            
            <div id="btn-inventory" class="menu-button" onclick="showTab('inventory')">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div id="btn-cases" class="menu-button" onclick="showTab('cases')">–ö–µ–π—Å—ã</div>
        </div>
    </div>
    
    <div id="difficulty-menu-content" class="tab-content" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #4A00E0, #8E2DE2); z-index: 1001; flex-direction: column; align-items: center; justify-content: center;">
        <div id="menu-title" style="margin-bottom: 30px;">–í—ã–±–µ—Ä–∏—Ç–µ –°–ª–æ–∂–Ω–æ—Å—Ç—å</div>
        <div style="display: flex; gap: 30px; margin-top: 20px;">
            <div class="menu-button" onclick="startNewGameWithSpeed(150)" style="background-color: #2ecc71; width: 180px;">üê¢ –õ–µ–≥–∫–æ (150ms)</div>
            <div class="menu-button" onclick="startNewGameWithSpeed(100)" style="background-color: #3498db; width: 180px;">üö∂ –ù–æ—Ä–º–∞–ª—å–Ω–æ (100ms)</div>
            <div class="menu-button" onclick="startNewGameWithSpeed(50)" style="background-color: #e74c3c; width: 180px;">‚ö°Ô∏è –°–ª–æ–∂–Ω–æ (50ms)</div>
        </div>
        <button class="back-button" onclick="showTab('main-menu')" style="margin-top: 50px;">‚Üê –ù–∞–∑–∞–¥</button>
    </div>


    <div id="game-content" class="tab-content">
        <h2>–¢–µ–∫—É—â–∏–π —Å–∫–∏–Ω: <span id="current-skin-name">–ó–µ–ª–µ–Ω—ã–π</span></h2>
        <button onclick="startNewGameWithSpeed(baseFrameRate)">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ò–≥—Ä—É</button> 
        <canvas id="gameCanvas" width="500" height="500"></canvas>
    </div>

    <div id="shop-content" class="tab-content">
        <h2>–ú–∞–≥–∞–∑–∏–Ω –°–∫–∏–Ω–æ–≤</h2>
        <div id="skins-list">
            </div>
    </div>

    <div id="cases-content" class="tab-content">
        <h2>–û—Ç–∫—Ä—ã—Ç—å –ö–µ–π—Å</h2>
        
        <div id="case-container-basic" style="margin-bottom: 50px; border: 2px solid #3498db; padding: 20px; border-radius: 10px;">
            <h3>"–°–ª—É—á–∞–π–Ω—ã–π –°–∫–∏–Ω" –ö–µ–π—Å (–¶–µ–Ω–∞: 15 –º–æ–Ω–µ—Ç)</h3>
            <p>–®–∞–Ω—Å –Ω–∞ –º–∏—Ñ–∏—á–µ—Å–∫–∏–π —Å–∫–∏–Ω: 2%.</p>
            <div id="buy-case-area">
                <button id="buy-case-button" onclick="buyCase(BASIC_CASE_PRICE, 'basic')">–ö—É–ø–∏—Ç—å –ö–µ–π—Å (15 –º–æ–Ω–µ—Ç)</button>
            </div>
        </div>

        <div id="case-container-rare" style="border: 2px solid #f1c40f; padding: 20px; border-radius: 10px;">
            <h3>‚≠ê –ü–†–ï–ú–ò–£–ú-–ö–µ–π—Å (–¶–µ–Ω–∞: 50 –º–æ–Ω–µ—Ç)</h3>
            <p>–®–∞–Ω—Å –Ω–∞ –º–∏—Ñ–∏—á–µ—Å–∫–∏–π —Å–∫–∏–Ω: 8%.</p>
            <button onclick="buyCase(PREMIUM_CASE_PRICE, 'premium')">–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º-–ö–µ–π—Å (50 –º–æ–Ω–µ—Ç)</button>
        </div>

        <div id="case-result-wrapper">
            <div id="indicator"></div> 
            <div id="skin-roll">
                </div>
        </div>

        <div id="case-controls">
            <button id="open-case-button" onclick="openCaseAnimation()" disabled style="background-color: #555;">–û—Ç–∫—Ä—ã—Ç—å –ö–µ–π—Å</button>
            <div id="case-status">–ö—É–ø–∏—Ç–µ –∫–µ–π—Å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</div>
        </div>

        <h4>–ë–∞–∑–æ–≤—ã–µ –®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è:</h4>
        <ul style="list-style: none; padding: 0;">
            <li class="rarity-common">–û–±—ã—á–Ω—ã–µ: 45%</li>
            <li class="rarity-rare">–†–µ–¥–∫–∏–µ: 30%</li>
            <li class="rarity-epic">–≠–ø–∏—á–µ—Å–∫–∏–µ: 15%</li>
            <li class="rarity-legendary">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ: 8%</li>
            <li class="rarity-mythical">–ú–∏—Ñ–∏—á–µ—Å–∫–∏–µ: 2%</li>
        </ul>
    </div>
    
    <div id="inventory-content" class="tab-content">
        <h2>–í–∞—à –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>

        <h3>–í–∞—à–∏ –°–∫–∏–Ω—ã</h3>
        <p>–ü—Ä–æ–¥–∞–∂–∞ —Å–∫–∏–Ω–æ–≤: 50% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏.</p>
        <div id="inventory-skins-list">
            </div>

        <h3>–û–±–º–µ–Ω –æ—á–∫–æ–≤ –Ω–∞ –º–æ–Ω–µ—Ç—ã</h3>
        <button onclick="convertScoreToCoins()" style="background-color: #2ecc71; font-size: 1.1em;">–û–±–º–µ–Ω—è—Ç—å –û—á–∫–∏ (3:1)</button>

        <div id="admin-controls">
            <h3>–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
            <button onclick="showPromocodes()" style="background-color: #3498db;">üîë –ü—Ä–æ–º–æ–∫–æ–¥—ã</button>
            <button onclick="grantAdminCoins()">üëë Admin</button>
        </div>
    </div>

    <div id="stats-content" class="tab-content">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ò–≥—Ä–æ–∫–∞</h2>
        <div class="stats-grid" id="stats-display">
            </div>
    </div>

    <div id="achievements-content" class="tab-content">
        <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <p>–ü–æ–ª—É—á–∞–π—Ç–µ –º–µ–¥–∞–ª–∏ –∑–∞ –æ—Å–æ–±—ã–µ –∏–≥—Ä–æ–≤—ã–µ –∑–∞—Å–ª—É–≥–∏.</p>
        <div class="achievement-grid" id="achievements-display">
             </div>
    </div>


    <script>
        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 25; 
        const tileCount = canvas.width / gridSize;
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = 0;
        let gameLoopInterval;
        let isGameOver = false;
        let foodType = 'normal'; // –¢–∏–ø –µ–¥—ã (normal, gold, poison, slow)
        
        // --- –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–ö–û–†–û–°–¢–ò ---
        let baseFrameRate = 100; // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∏–≥—Ä–æ–∫–æ–º (150, 100, 50ms)
        let gameSpeed = 100; // –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã
        let slowDownTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
        
        // --- –≠–ö–û–ù–û–ú–ò–ö–ê –ò –°–ö–ò–ù–´ ---
        let score = 0;
        let coins = 0;
        let equippedSkin = 'green';
        const CONVERSION_RATE = 3; 
        let casesOwned = 0; 

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞
        let gameStats = {
            maxScore: 0,
            totalScore: 0,
            totalApplesEaten: 0,
            totalDeaths: 0,
            goldApplesCaught: 0,
            poisonApplesCaught: 0,
            adminAccessUsed: false,
            activatedPromocodes: {},
            maxTailLength: 1 
        };

        const SKINS = { 
            'green':    { price: 0, color: '#4CAF50', owned: true, name: '–ó–µ–ª–µ–Ω—ã–π (–ë–∞–∑–∞)', rarity: 'common' },
            'blue':     { price: 10, color: '#2196F3', owned: false, name: '–°–∏–Ω–∏–π', rarity: 'common' },
            'cyan':     { price: 25, color: '#00BCD4', owned: false, name: '–ë–∏—Ä—é–∑–æ–≤—ã–π', rarity: 'common' },
            'grey':     { price: 30, color: '#9E9E9E', owned: false, name: '–°–µ—Ä—ã–π', rarity: 'common' },
            'yellow':   { price: 50, color: '#FFEB3B', owned: false, name: '–ñ–µ–ª—Ç—ã–π', rarity: 'rare' },
            'red':      { price: 80, color: '#FF5733', owned: false, name: '–ö—Ä–∞—Å–Ω—ã–π', rarity: 'rare' },
            'orange':   { price: 100, color: '#FF9800', owned: false, name: '–û—Ä–∞–Ω–∂–µ–≤—ã–π', rarity: 'rare' },
            'brown':    { price: 120, color: '#795548', owned: false, name: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π', rarity: 'rare' },
            'purple':   { price: 150, color: '#8A2BE2', owned: false, name: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–≠–ø–∏–∫)', rarity: 'epic' },
            'pink':     { price: 200, color: '#E91E63', owned: false, name: '–†–æ–∑–æ–≤—ã–π', rarity: 'epic' },
            'black':    { price: 250, color: '#333333', owned: false, name: '–ß–µ—Ä–Ω—ã–π', rarity: 'epic' },
            'magenta':  { price: 300, color: '#FF00FF', owned: false, name: '–ú–∞–¥–∂–µ–Ω—Ç–∞', rarity: 'epic' },
            'gold':     { price: 350, color: '#FFD700', owned: false, name: '–ó–æ–ª–æ—Ç–æ–π', rarity: 'legendary' },
            'diamond':  { price: 500, color: '#B9F2FF', owned: false, name: '–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç', rarity: 'legendary' },
            'lava':     { price: 750, color: '#F44336', owned: false, name: '–õ–∞–≤–∞ (–ú–∏—Ñ.)', rarity: 'mythical' },
            'darkmatter': { price: 1000, color: '#1B2A49', owned: false, name: '–¢–µ–º–Ω–∞—è –ú–∞—Ç–µ—Ä–∏—è', rarity: 'mythical' },
            'hologram': { price: 1500, color: '#00FFFF', owned: false, name: '–ì–æ–ª–æ–≥—Ä–∞–º–º–∞', rarity: 'mythical' },
            'rainbow':  { price: 5000, color: 'linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)', owned: false, name: '–†–∞–¥—É–≥–∞ (–°–ø–µ—Ü.)', rarity: 'mythical' },
        };

        const BASIC_CASE_PRICE = 15;
        const PREMIUM_CASE_PRICE = 50;
        
        // –®–∞–Ω—Å—ã –¥–ª—è –ë–∞–∑–æ–≤–æ–≥–æ –ö–µ–π—Å–∞
        const BASIC_CASE_CHANCES = {
            'common': 45, 'rare': 30, 'epic': 15, 'legendary': 8, 'mythical': 2
        };

        // –®–∞–Ω—Å—ã –¥–ª—è –ü—Ä–µ–º–∏—É–º-–ö–µ–π—Å–∞
        const PREMIUM_CASE_CHANCES = { 
            'common': 20, 'rare': 30, 'epic': 30, 'legendary': 12, 'mythical': 8
        };
        
        // –í–ê–®–ò –ü–†–û–ú–û–ö–û–î–´
        const PROMOCODES = {
            'SNAKECREATOR': { type: 'coins', amount: 10, message: 'üéâ +10 –ú–æ–Ω–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã!' },
            'SNAKEGAME': { type: 'case', amount: 1, message: 'üéÅ +1 –ö–µ–π—Å! –£–¥–∞—á–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–∏–∏!' },
            'TOPER': { type: 'skin', skinId: 'red', message: 'üêç –í—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–∫–∏–Ω "–ö—Ä–∞—Å–Ω—ã–π"!' }
        };

        // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        const ACHIEVEMENTS = {
            'goldKing': {
                name: '–ó–æ–ª–æ—Ç–æ–π –ö–æ—Ä–æ–ª—å',
                description: '–ü–æ–π–º–∞—Ç—å 10 –ó–æ–ª–æ—Ç—ã—Ö –Ø–±–ª–æ–∫.',
                icon: 'üëë',
                unlocked: false,
                check: () => gameStats.goldApplesCaught >= 10
            },
            'adminAccess': {
                name: '–ê–¥–º–∏–Ω',
                description: '–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∫–µ.',
                icon: 'üîë',
                unlocked: false,
                check: () => gameStats.adminAccessUsed
            },
            'corpse': {
                name: '–ú–µ—Ä—Ç–≤–µ—Ü',
                description: '–ü–æ–π–º–∞—Ç—å 5 –Ø–¥–æ–≤–∏—Ç—ã—Ö –Ø–±–ª–æ–∫.',
                icon: 'üíÄ',
                unlocked: false,
                check: () => gameStats.poisonApplesCaught >= 5
            },
            // –õ–ï–ì–ï–ù–î–ê–†–ù–´–ô –ë–ê–ì (–¢–∏—Ö–∏–π –∞–Ω–ª–æ–∫)
            'legendaryBug': { 
                name: '–õ–µ–≥–µ–Ω–¥–∞ 1.0',
                description: '–ù–∞–π–¥–µ–Ω –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ë–∞–≥ –¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏ –Ø–±–ª–æ–∫ (V1.0 - V1.2).',
                icon: 'üï∞Ô∏è',
                unlocked: false,
                check: () => true 
            },
            'epicTail': {
                name: '–≠–ø–∏—á–µ—Å–∫–∏–π –•–≤–æ—Å—Ç',
                description: '–î–ª–∏–Ω–∞ –∑–º–µ–π–∫–∏ –¥–æ—Å—Ç–∏–≥–ª–∞ 15 —Å–µ–≥–º–µ–Ω—Ç–æ–≤.',
                icon: 'üêâ',
                unlocked: false,
                check: () => snake.length >= 15
            },
            'hundredScore': {
                name: '–°–æ—Ç–Ω—è –û—á–∫–æ–≤',
                description: '–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤ –≤ –æ–¥–Ω–æ–π –∏–≥—Ä–µ.',
                icon: 'üíØ',
                unlocked: false,
                check: () => score >= 100
            }
        };


        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const scoreDisplay = document.getElementById('score');
        const coinsDisplay = document.getElementById('coins');
        const skinsList = document.getElementById('skins-list');
        const inventorySkinsList = document.getElementById('inventory-skins-list');
        const rollElement = document.getElementById('skin-roll');
        const openCaseButton = document.getElementById('open-case-button');
        const caseStatus = document.getElementById('case-status');
        const progressionDisplay = document.getElementById('progression-display');
        const headerBar = document.getElementById('header-bar');
        const statsDisplay = document.getElementById('stats-display');
        const achievementsDisplay = document.getElementById('achievements-display');
        const mainMenuContent = document.getElementById('main-menu-content'); // –î–æ–±–∞–≤–ª–µ–Ω–æ
        const difficultyMenuContent = document.getElementById('difficulty-menu-content'); // –î–æ–±–∞–≤–ª–µ–Ω–æ
        
        let caseReady = false; 
        let winningsId = null; 
        const rollItemWidth = 100; 

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

        function getRarityColor(rarity) {
            const tempDiv = document.createElement('div');
            tempDiv.className = `rarity-${rarity}`;
            document.body.appendChild(tempDiv);
            const color = window.getComputedStyle(tempDiv).color;
            document.body.removeChild(tempDiv);
            return color || '#ecf0f1';
        }

        function checkAchievements() {
            let newlyUnlocked = false;
            for (const id in ACHIEVEMENTS) {
                const achievement = ACHIEVEMENTS[id];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –∫—Ä–æ–º–µ "–õ–µ–≥–µ–Ω–¥–∞ 1.0", –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                if (id !== 'legendaryBug' && !achievement.unlocked && achievement.check()) {
                    achievement.unlocked = true;
                    newlyUnlocked = true;
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
                    alert(`üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ: ${achievement.name}!`); 
                }
            }
            if (newlyUnlocked && document.getElementById('achievements-content').classList.contains('active')) {
                renderAchievements();
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ì–†–ï–°–°–û–ú –ò UI ---

        window.updateAllUI = function() {
            scoreDisplay.textContent = score;
            coinsDisplay.textContent = coins;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ë–∞–∑–æ–≤–æ–≥–æ –ö–µ–π—Å–∞
            const buyCaseButton = document.getElementById('buy-case-button');
            if (buyCaseButton) {
                 buyCaseButton.textContent = `–ö—É–ø–∏—Ç—å –ö–µ–π—Å (${BASIC_CASE_PRICE} –º–æ–Ω–µ—Ç)`;
            }

            if (document.getElementById('current-skin-name')) {
                document.getElementById('current-skin-name').textContent = SKINS[equippedSkin].name;
            }
            if (document.getElementById('shop-content').classList.contains('active')) {
                renderShop();
            }
            if (document.getElementById('inventory-content').classList.contains('active')) {
                renderInventory();
            }
            if (document.getElementById('stats-content').classList.contains('active')) {
                renderStats();
            }
            if (document.getElementById('achievements-content').classList.contains('active')) {
                renderAchievements();
            }
        }

        window.saveProgress = function() { 
            try {
                const saveData = {
                    score, coins, equippedSkin, casesOwned, gameStats, 
                    skins: Object.keys(SKINS).reduce((acc, id) => {
                        acc[id] = { owned: SKINS[id].owned };
                        return acc;
                    }, {}),
                    achievements: Object.keys(ACHIEVEMENTS).reduce((acc, id) => { 
                        acc[id] = { unlocked: ACHIEVEMENTS[id].unlocked };
                        return acc;
                    }, {}),
                    baseFrameRate
                };
                localStorage.setItem('snakeGameProgress', JSON.stringify(saveData));
                alert('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } catch (e) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e); }
        }

        function loadProgress() { 
            const savedData = localStorage.getItem('snakeGameProgress');
            if (savedData) {
                const data = JSON.parse(savedData);
                score = data.score || 0;
                coins = data.coins || 0;
                equippedSkin = data.equippedSkin || 'green';
                casesOwned = data.casesOwned || 0; 
                
                baseFrameRate = data.baseFrameRate || 100;
                gameSpeed = baseFrameRate;

                if (data.gameStats) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Object.assign, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å maxTailLength, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ
                    Object.assign(gameStats, { ...data.gameStats, maxTailLength: data.gameStats.maxTailLength || 1 }); 
                    if (!gameStats.activatedPromocodes) gameStats.activatedPromocodes = {};
                } else {
                    gameStats.activatedPromocodes = {};
                }

                if (data.skins) {
                    for (const id in data.skins) {
                        if (SKINS[id]) {
                            SKINS[id].owned = data.skins[id].owned;
                        }
                    }
                }
                
                if (data.achievements) {
                    for (const id in data.achievements) {
                        if (ACHIEVEMENTS[id]) {
                            ACHIEVEMENTS[id].unlocked = data.achievements[id].unlocked;
                        }
                    }
                }
                
                // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –õ–ï–ì–ï–ù–î–ê–†–ù–û–ì–û –ë–ê–ì–ê (–¢–∏—Ö–∏–π –∞–Ω–ª–æ–∫)
                if (!ACHIEVEMENTS['legendaryBug'].unlocked) {
                     ACHIEVEMENTS['legendaryBug'].unlocked = true;
                }
                
            } else {
                 SKINS['green'].owned = true;
                 ACHIEVEMENTS['legendaryBug'].unlocked = true;
            }
        }
        
        window.grantAdminCoins = function() { 
            const adminCoins = 1000000;
            const confirmCode = prompt("–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–Ω–µ—Ç.");
            if (confirmCode === 'ADMIN_GOLD') { 
                coins = adminCoins;
                gameStats.adminAccessUsed = true; 
                checkAchievements(); 
                updateAllUI();
                saveProgress();
                alert(`–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${coins.toLocaleString()} –º–æ–Ω–µ—Ç!`);
            } else if (confirmCode !== null) {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.");
            }
        }
        
        window.showPromocodes = function() {
            const inputCode = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥:");
            if (inputCode) {
                applyPromocode(inputCode.toUpperCase());
            }
        }

        function applyPromocode(code) {
            const promo = PROMOCODES[code];
            
            if (!promo) {
                alert('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            if (gameStats.activatedPromocodes[code]) {
                alert(`‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ "${code}" —É–∂–µ –±—ã–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`);
                return;
            }

            gameStats.activatedPromocodes[code] = true;
            let successMessage = promo.message;

            switch (promo.type) {
                case 'coins':
                    coins += promo.amount;
                    break;
                case 'case':
                    casesOwned += promo.amount;
                    break;
                case 'skin':
                    const skinId = promo.skinId;
                    if (SKINS[skinId]) {
                        if (SKINS[skinId].owned) {
                            const compensation = Math.ceil(SKINS[skinId].price / 10) || 5; 
                            coins += compensation;
                            successMessage += ` (–£–∂–µ –µ—Å—Ç—å, +${compensation} –º–æ–Ω–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.)`;
                        } else {
                            SKINS[skinId].owned = true;
                        }
                    }
                    break;
            }
            
            updateAllUI();
            saveProgress();
            alert(`‚úÖ –£—Å–ø–µ—Ö! ${successMessage}`);
        }
        
        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã
        window.startNewGameWithSpeed = function(speed) {
            baseFrameRate = speed; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –∏–≥—Ä—ã
            difficultyMenuContent.classList.remove('active');
            
            showTab('game'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∏–≥—Ä—ã
            startGame(); // –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É
        }

        function resetGame() { 
            snake = [{x: 10, y: 10}]; 
            dx = 1; 
            dy = 0; 
            isGameOver = false; 
            score = 0;
            foodType = 'normal'; 
            
            // –°–±—Ä–æ—Å –∏ –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Å–∫–æ—Ä–æ—Å—Ç–∏
            if (slowDownTimer) clearTimeout(slowDownTimer); 
            gameSpeed = baseFrameRate; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–∞–∑–æ–≤–æ–π
            
            if (gameLoopInterval) clearInterval(gameLoopInterval); 
            
            generateFood(); 
        }
        
        window.startGame = function() { 
            resetGame(); 
            gameLoopInterval = setInterval(update, gameSpeed); 
            updateAllUI();
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–¥—ã —Å —à–∞–Ω—Å–∞–º–∏
        function generateFood() { 
             let newFood;
             let type;
             
             // –®–∞–Ω—Å—ã: –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ (75%), –ó–æ–ª–æ—Ç–æ–µ (10%), –Ø–¥–æ–≤–∏—Ç–æ–µ (5%), –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ (10%)
             const rand = Math.random() * 100;
             if (rand < 10) { // 10%
                 type = 'gold';
             } else if (rand < 15) { // 5%
                 type = 'poison';
             } else if (rand < 25) { // 10%
                 type = 'slow';
             } else { // 75%
                 type = 'normal';
             }

            do {
                newFood = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
            } while (snake.some(segment => segment.x === newFood.x && newFood.y === newFood.y)); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ `food.y === food.y` –Ω–∞ `newFood.y === newFood.y` (—Ö–æ—Ç—è —ç—Ç–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ–ø–µ—á–∞—Ç–∫–∞)
            
            food = newFood;
            foodType = type;
        }

        function checkCollision(head) { 
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) return true;
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) return true;
            }
            return false;
        }
        
        function update() { 
            if (isGameOver) return;
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            if (checkCollision(head)) { gameOver(); return; }
            snake.unshift(head);
            
            let ate = false;

            if (head.x === food.x && head.y === food.y) { 
                ate = true;
                gameStats.totalApplesEaten++; 
                
                if (foodType === 'normal') {
                    score++;
                } else if (foodType === 'gold') {
                    score += 5; 
                    coins += 1; 
                    gameStats.goldApplesCaught++; 
                } else if (foodType === 'poison') {
                    score = Math.max(0, score - 5); 
                    if (snake.length > 3) { 
                        snake.pop(); 
                        snake.pop(); 
                    } else if (snake.length > 1) { 
                        snake.pop();
                    }
                    gameStats.poisonApplesCaught++; 
                    alert('‚ùå –Ø–î–û–í–ò–¢–û–ï –Ø–ë–õ–û–ö–û! -5 –æ—á–∫–æ–≤ –∏ —Ö–≤–æ—Å—Ç —É–º–µ–Ω—å—à–µ–Ω.');
                } else if (foodType === 'slow') { 
                    const SLOW_SPEED = baseFrameRate + 100; // –ó–∞–º–µ–¥–ª—è–µ–º –Ω–∞ 100–º—Å
                    const SLOW_DURATION = 5000; // 5 —Å–µ–∫—É–Ω–¥
                    
                    if (slowDownTimer) clearTimeout(slowDownTimer);
                    
                    gameSpeed = SLOW_SPEED; 
                    clearInterval(gameLoopInterval);
                    gameLoopInterval = setInterval(update, gameSpeed);
                    
                    slowDownTimer = setTimeout(() => {
                        gameSpeed = baseFrameRate; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                        clearInterval(gameLoopInterval);
                        gameLoopInterval = setInterval(update, gameSpeed);
                        alert('‚ö°Ô∏è –≠—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª—Å—è!');
                        slowDownTimer = null;
                    }, SLOW_DURATION);
                    
                    alert('üê¢ –ó–ê–ú–ï–î–õ–ï–ù–ò–ï! –°–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥.');
                }

                generateFood(); 
            }
            
            if (!ate) { 
                snake.pop(); 
            }
            
            gameStats.maxScore = Math.max(gameStats.maxScore, score);
            gameStats.maxTailLength = Math.max(gameStats.maxTailLength, snake.length);
            
            checkAchievements(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å—ä–µ–¥–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª–∏–Ω—ã –∏ —Å—á–µ—Ç–∞)
            
            drawGame(); 
            updateAllUI();
        }
        
        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –µ–¥—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        function drawGame() { 
            ctx.fillStyle = 'black'; ctx.fillRect(0, 0, canvas.width, canvas.height); 
            
            if (foodType === 'normal') {
                ctx.fillStyle = 'red';
            } else if (foodType === 'gold') {
                ctx.fillStyle = 'gold';
            } else if (foodType === 'poison') {
                ctx.fillStyle = '#9b59b6'; 
            } else if (foodType === 'slow') { 
                ctx.fillStyle = '#1ABC9C'; // –ë–∏—Ä—é–∑–æ–≤—ã–π
            }
            
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 1, gridSize - 1);
            
            const skin = SKINS[equippedSkin];
            if (equippedSkin === 'rainbow') {
                const colors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'];
                snake.forEach((segment, index) => {
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
                });
            } else {
                ctx.fillStyle = skin.color.startsWith('#') ? skin.color : 'white';
                snake.forEach(segment => {
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
                });
            }
        }
        
        function gameOver() { 
            isGameOver = true; 
            clearInterval(gameLoopInterval); 
            
            if (slowDownTimer) clearTimeout(slowDownTimer);
            gameSpeed = baseFrameRate; // –°–±—Ä–æ—Å –¥–æ –±–∞–∑–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
            
            gameStats.totalDeaths++; 
            gameStats.totalScore += score; 
            
            ctx.fillStyle = 'white'; ctx.font = '30px Arial';
            ctx.fillText(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ${score}`, canvas.width / 2 - 150, canvas.height / 2);
            updateAllUI(); 
            checkAchievements(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ —Å–º–µ—Ä—Ç–∏
        }
        document.addEventListener('keydown', e => { 
            if (e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -1; }
            else if (e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 1; }
            else if (e.key === 'ArrowLeft' && dx === 0) { dx = -1; dy = 0; }
            else if (e.key === 'ArrowRight' && dx === 0) { dx = 1; dy = 0; }
        });

        // --- –ú–ê–ì–ê–ó–ò–ù –ò –ò–ù–í–ï–ù–¢–ê–†–¨ ---
        window.convertScoreToCoins = function() { 
            if (score >= CONVERSION_RATE) {
                const newCoins = Math.floor(score / CONVERSION_RATE);
                const scoreSpent = newCoins * CONVERSION_RATE;
                score -= scoreSpent; coins += newCoins; updateAllUI();
                alert(`${scoreSpent} –æ—á–∫–æ–≤ –æ–±–º–µ–Ω—è–Ω–æ –Ω–∞ ${newCoins} –º–æ–Ω–µ—Ç!`);
            } else {
                alert(`–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã ${CONVERSION_RATE} –æ—á–∫–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ (—Ç–µ–∫—É—â–µ–µ: ${score}).`);
            }
        }
        window.buySkin = function(id, price) { 
            if (SKINS[id].owned) return;
            if (coins >= price) {
                coins -= price; SKINS[id].owned = true; updateAllUI();
                alert(`–°–∫–∏–Ω "${SKINS[id].name}" –∫—É–ø–ª–µ–Ω!`);
            } else { alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –¢—Ä–µ–±—É–µ—Ç—Å—è ${price}, —É –≤–∞—Å ${coins}.`); }
        }
        window.equipSkin = function(id) { 
            if (SKINS[id].owned) {
                equippedSkin = id; updateAllUI();
                alert(`–°–∫–∏–Ω "${SKINS[id].name}" —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω!`);
            } else { alert('–°–∫–∏–Ω –Ω–µ –∫—É–ø–ª–µ–Ω!'); }
        }
        window.sellSkin = function(id) { 
            if (id === 'green') { alert('–ë–∞–∑–æ–≤—ã–π —Å–∫–∏–Ω –ø—Ä–æ–¥–∞—Ç—å –Ω–µ–ª—å–∑—è.'); return; }
            if (id === equippedSkin) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ —Å–∫–∏–Ω, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–¥–∞–≤–∞—Ç—å –µ–≥–æ.'); return; }
            if (SKINS[id].owned) {
                const refund = Math.floor(SKINS[id].price / 2); coins += refund;
                SKINS[id].owned = false; updateAllUI();
                alert(`–°–∫–∏–Ω "${SKINS[id].name}" –ø—Ä–æ–¥–∞–Ω –∑–∞ ${refund} –º–æ–Ω–µ—Ç!`);
            }
        }
        
        function renderShop() { 
            skinsList.innerHTML = '';
            for (const id in SKINS) {
                const skin = SKINS[id];
                
                const listItem = document.createElement('div');
                listItem.className = 'skin-item';
                let skinColorStyle = '';
                if (skin.color.startsWith('linear-gradient')) {
                    skinColorStyle = `background: ${skin.color}; color: #333;`;
                } else {
                    skinColorStyle = `background-color: ${skin.color}; color: ${id === 'yellow' || id === 'gold' || id === 'diamond' ? '#333' : 'white'};`;
                }
                listItem.style = skinColorStyle;

                let buttonHTML = `<h4>${skin.name}</h4><p class="rarity-${skin.rarity}">${skin.rarity.toUpperCase()}</p>`;
                
                if (skin.owned) {
                    buttonHTML += `<p style="margin-top: 10px;">‚úîÔ∏è –ö–£–ü–õ–ï–ù–û</p>`;
                } else {
                    buttonHTML += `<button class="btn-buy" onclick="buySkin('${id}', ${skin.price})">–ö—É–ø–∏—Ç—å (${skin.price} –º–æ–Ω–µ—Ç)</button>`;
                }
                
                listItem.innerHTML = buttonHTML; skinsList.appendChild(listItem);
            }
        }

        function renderInventory() { 
            inventorySkinsList.innerHTML = '';
            let hasSkins = false;
            for (const id in SKINS) {
                const skin = SKINS[id];
                if (skin.owned) {
                    hasSkins = true;
                    const refundPrice = Math.floor(skin.price / 2);
                    const listItem = document.createElement('div');
                    listItem.className = 'skin-item';
                    
                    let skinColorStyle = '';
                    if (skin.color.startsWith('linear-gradient')) {
                        skinColorStyle = `background: ${skin.color}; color: #333;`;
                    } else {
                        skinColorStyle = `background-color: ${skin.color}; color: ${id === 'yellow' || id === 'gold' || id === 'diamond' ? '#333' : 'white'};`;
                    }
                    listItem.style = skinColorStyle;

                    let buttonHTML = `<h4>${skin.name}</h4><p class="rarity-${skin.rarity}">${skin.rarity.toUpperCase()}</p>`;
                    
                    if (id === equippedSkin) {
                        buttonHTML += `<p class="equipped-status">üî• –≠–ö–ò–ü–ò–†–û–í–ê–ù</p>`;
                    } else {
                        buttonHTML += `<button class="btn-equip" onclick="equipSkin('${id}')">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    }
                    
                    if (id !== 'green') {
                        buttonHTML += `<button class="btn-sell" onclick="sellSkin('${id}')">–ü—Ä–æ–¥–∞—Ç—å (${refundPrice})</button>`;
                    }
                    
                    listItem.innerHTML = buttonHTML;
                    inventorySkinsList.appendChild(listItem);
                }
            }
            if (!hasSkins) {
                inventorySkinsList.innerHTML = '<p style="padding: 20px;">–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ –ú–∞–≥–∞–∑–∏–Ω –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ö–µ–π—Å!</p>';
            }
        }

        function renderStats() {
            statsDisplay.innerHTML = '';
            
            const statsData = [
                { title: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—á–µ—Ç', value: gameStats.maxScore, unit: '‚òÖ' },
                { title: '–í—Å–µ–≥–æ –Ω–∞–±–∏—Ç–æ –æ—á–∫–æ–≤', value: gameStats.totalScore, unit: '‚òÖ' },
                { title: '–ú–∞–∫—Å. –¥–ª–∏–Ω–∞ —Ö–≤–æ—Å—Ç–∞', value: gameStats.maxTailLength, unit: 'üìè' },
                { title: '–í—Å–µ–≥–æ —Å—ä–µ–¥–µ–Ω–æ —è–±–ª–æ–∫', value: gameStats.totalApplesEaten, unit: 'üçè' },
                { title: '–ó–æ–ª–æ—Ç—ã—Ö —è–±–ª–æ–∫ –ø–æ–π–º–∞–Ω–æ', value: gameStats.goldApplesCaught, unit: '‚≠ê' },
                { title: '–Ø–¥–æ–≤–∏—Ç—ã—Ö —è–±–ª–æ–∫ –ø–æ–π–º–∞–Ω–æ', value: gameStats.poisonApplesCaught, unit: 'üíÄ' },
                { title: '–í—Å–µ–≥–æ —Å–º–µ—Ä—Ç–µ–π', value: gameStats.totalDeaths, unit: 'üòµ' },
            ];

            statsData.forEach(stat => {
                const item = document.createElement('div');
                item.className = 'stat-item';
                item.innerHTML = `
                    <h4>${stat.unit} ${stat.value}</h4>
                    <p>${stat.title}</p>
                `;
                statsDisplay.appendChild(item);
            });
        }

        function renderAchievements() {
            achievementsDisplay.innerHTML = '';

            for (const id in ACHIEVEMENTS) {
                const achievement = ACHIEVEMENTS[id];
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
                
                const statusIcon = achievement.unlocked ? achievement.icon : 'üîí';
                
                item.innerHTML = `
                    <h4>${achievement.name}</h4>
                    <div class="achievement-status">${statusIcon}</div>
                    <p>${achievement.description}</p>
                `;
                achievementsDisplay.appendChild(item);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ï–ô–°–û–í ---

        function determineDrop(caseType) {
            const chances = caseType === 'premium' ? PREMIUM_CASE_CHANCES : BASIC_CASE_CHANCES;
            
            const rand = Math.random() * 100;
            let cumulative = 0;
            let rarityDrop;

            for (const rarity in chances) {
                cumulative += chances[rarity];
                if (rand < cumulative) {
                    rarityDrop = rarity;
                    break;
                }
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ —Å–∫–∏–Ω—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—ã–ø–∞–≤—à–µ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
            const availableSkins = Object.keys(SKINS).filter(id => SKINS[id].rarity === rarityDrop);
            const skinId = availableSkins[Math.floor(Math.random() * availableSkins.length)];
            return skinId;
        }
        
        window.buyCase = function(price, caseType) {
            
            if (coins < price) {
                caseStatus.textContent = `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –¢—Ä–µ–±—É–µ—Ç—Å—è ${price}.`;
                caseStatus.style.color = '#e74c3c';
                return;
            }
            
            coins -= price;
            
            // –¢–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –≤–µ–¥–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–µ–π—Å–æ–≤, –º—ã –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤–∏–º –∞–Ω–∏–º–∞—Ü–∏—é
            
            updateAllUI();
            
            caseReady = true;
            openCaseButton.disabled = false;
            openCaseButton.style.backgroundColor = '#e74c3c';
            caseStatus.textContent = `–ö–µ–π—Å –∫—É–ø–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å –ö–µ–π—Å"! (${caseType.toUpperCase()})`;
            caseStatus.style.color = '#2ecc71';
            
            winningsId = determineDrop(caseType);
            prepareRoll(winningsId);
        }

        function prepareRoll(winningId) {
            rollElement.style.transition = 'none';
            rollElement.style.transform = `translateX(0px)`;
            
            const allSkinIds = Object.keys(SKINS);
            let rollSequence = [];
            
            for(let i = 0; i < 20; i++) {
                rollSequence.push(allSkinIds[Math.floor(Math.random() * allSkinIds.length)]);
            }
            
            const winningPosition = 25; 
            
            for(let i = 0; i < (winningPosition - rollSequence.length); i++) {
                 rollSequence.push(allSkinIds[Math.floor(Math.random() * allSkinIds.length)]); 
            }
            
            rollSequence.push(winningId); 
            
            for(let i = 0; i < 20; i++) {
                rollSequence.push(allSkinIds[Math.floor(Math.random() * allSkinIds.length)]);
            }

            rollElement.innerHTML = rollSequence.map(id => {
                const skin = SKINS[id];
                const colorStyle = skin.color.startsWith('linear-gradient') ? `background: ${skin.color};` : `background-color: ${skin.color};`;
                return `<div class="roll-item rarity-${skin.rarity}" style="${colorStyle}">${skin.name.split(' ')[0]}</div>`;
            }).join('');
        }

        window.openCaseAnimation = function() {
            if (!caseReady || !winningsId) {
                caseStatus.textContent = '–°–Ω–∞—á–∞–ª–∞ –∫—É–ø–∏—Ç–µ –∫–µ–π—Å!';
                caseStatus.style.color = '#e74c3c';
                return;
            }
            
            openCaseButton.disabled = true;
            openCaseButton.style.backgroundColor = '#555';
            caseReady = false;
            
            const winningIndex = 25; 
            const centerOfContainer = 350; 
            
            const targetOffset = (winningIndex * rollItemWidth) + (rollItemWidth / 2) - centerOfContainer;
            
            rollElement.style.transition = 'none';
            rollElement.style.transform = `translateX(0px)`;
            
            void rollElement.offsetWidth;
            
            rollElement.style.transition = 'transform 5s cubic-bezier(0.2, 0.9, 0.3, 1)';
            rollElement.style.transform = `translateX(-${targetOffset}px)`;
            
            caseStatus.textContent = '–ö—Ä—É—Ç–∏–º...';
            caseStatus.style.color = '#3498db';

            setTimeout(() => {
                const droppedSkin = SKINS[winningsId];
                processWinnings(winningsId, droppedSkin);
                winningsId = null; 
            }, 5500); 
        }
        
        function processWinnings(droppedId, droppedSkin) {
            let message = `üéâ –í–´–ü–ê–õ –°–ö–ò–ù: ${droppedSkin.name}!`;
            let color = getRarityColor(droppedSkin.rarity); 

            if (droppedSkin.owned) {
                const compensation = Math.max(1, Math.floor(droppedSkin.price * 0.2)); 
                coins += compensation;
                message += ` (–£–∂–µ –µ—Å—Ç—å! –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: +${compensation} –º–æ–Ω–µ—Ç)`;
                color = '#f1c40f'; 
            } else {
                SKINS[droppedId].owned = true;
                message += ` (–î–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!)`;
            }
            
            caseStatus.textContent = message;
            caseStatus.style.color = color; 
            updateAllUI();
        }

        // --- –õ–û–ì–ò–ö–ê –í–ö–õ–ê–î–û–ö ---

        window.showTab = function(tabId) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ–Ω—é/–≤–∫–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –Ω—É–∂–Ω–æ–π
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            const currentTab = document.getElementById(`${tabId}-content`);
            if (currentTab) {
                currentTab.classList.add('active');
            }
            
            // –ï—Å–ª–∏ –º—ã –≤—ã—Ö–æ–¥–∏–º –∏–∑ –∏–≥—Ä—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (tabId !== 'game' && gameLoopInterval) {
                 clearInterval(gameLoopInterval);
            }
            
            // –ú–µ–Ω—é —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - –±–µ–∑ —à–∞–ø–∫–∏
            const isMainMenu = (tabId === 'main-menu' || tabId === 'difficulty-menu'); 
            const hasHeader = !isMainMenu; 
            
            headerBar.style.display = hasHeader ? 'flex' : 'none';
            
            document.body.style.background = isMainMenu ? 'linear-gradient(135deg, #4A00E0, #8E2DE2)' : '#2c3e50';
            
            const showProgression = ['shop', 'cases', 'inventory', 'stats', 'achievements'].includes(tabId);
            progressionDisplay.style.display = showProgression ? 'flex' : 'none';
            
            if (tabId === 'shop') {
                renderShop();
            } else if (tabId === 'cases') {
                // –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∫–µ–π—Å—ã, –≥–æ—Ç–æ–≤–∏–º –∞–Ω–∏–º–∞—Ü–∏—é
                caseReady = false; winningsId = null; openCaseButton.disabled = true; openCaseButton.style.backgroundColor = '#555';
                caseStatus.textContent = '–ö—É–ø–∏—Ç–µ –∫–µ–π—Å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.'; caseStatus.style.color = '#ecf0f1';
                prepareRoll('green'); 
            } else if (tabId === 'inventory') {
                renderInventory(); 
            } else if (tabId === 'stats') { 
                renderStats();
            } else if (tabId === 'achievements') { 
                renderAchievements();
            }
            
            updateAllUI();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            loadProgress();
            showTab('main-menu');
            updateAllUI();
        };
    </script>
</body>
</html>